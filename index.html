<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подарочек - Игра</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            background-color: #FFF8DC;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Окно загрузки */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FFF8DC;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
        }
        
        .loader-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #FF69B4;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #FFF8DC;
            position: relative;
            z-index: 1;
        }
        
        /* Стили для мобильной клавиатуры */
        .mobile-keyboard {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #f0f0f0;
            padding: 10px;
            box-sizing: border-box;
            display: none;
            z-index: 1000;
            touch-action: none;
        }
        
        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }
        
        .keyboard-key {
            min-width: 10%;
            height: 50px;
            margin: 2px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            touch-action: manipulation;
            flex-grow: 1;
        }
        
        .keyboard-key.wide {
            min-width: 20%;
        }
        
        .keyboard-key.space {
            min-width: 60%;
        }
        
        /* Кнопки управления текстом */
        .text-controls {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .text-control-btn {
            padding: 8px 15px;
            margin: 5px;
            background: #64A0D2;
            color: white;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Окно загрузки -->
    <div id="loader">
        <div class="loader-spinner"></div>
        <div>Загрузка игры...</div>
    </div>
    
    <canvas id="gameCanvas" width="1200" height="800"></canvas>
    
    <!-- Виртуальная клавиатура для мобильных устройств -->
    <div class="mobile-keyboard" id="mobileKeyboard">
        <div class="text-controls">
            <div class="text-control-btn" data-action="selectAll">Выделить всё</div>
            <div class="text-control-btn" data-action="clear">Очистить</div>
            <div class="text-control-btn" data-action="closeKeyboard">Скрыть</div>
        </div>
        
        <div class="keyboard-row">
            <div class="keyboard-key">1</div>
            <div class="keyboard-key">2</div>
            <div class="keyboard-key">3</div>
            <div class="keyboard-key">4</div>
            <div class="keyboard-key">5</div>
            <div class="keyboard-key">6</div>
            <div class="keyboard-key">7</div>
            <div class="keyboard-key">8</div>
            <div class="keyboard-key">9</div>
            <div class="keyboard-key">0</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key">й</div>
            <div class="keyboard-key">ц</div>
            <div class="keyboard-key">у</div>
            <div class="keyboard-key">к</div>
            <div class="keyboard-key">е</div>
            <div class="keyboard-key">н</div>
            <div class="keyboard-key">г</div>
            <div class="keyboard-key">ш</div>
            <div class="keyboard-key">щ</div>
            <div class="keyboard-key">з</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key">ф</div>
            <div class="keyboard-key">ы</div>
            <div class="keyboard-key">в</div>
            <div class="keyboard-key">а</div>
            <div class="keyboard-key">п</div>
            <div class="keyboard-key">р</div>
            <div class="keyboard-key">о</div>
            <div class="keyboard-key">л</div>
            <div class="keyboard-key">д</div>
            <div class="keyboard-key">ж</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key">я</div>
            <div class="keyboard-key">ч</div>
            <div class="keyboard-key">с</div>
            <div class="keyboard-key">м</div>
            <div class="keyboard-key">и</div>
            <div class="keyboard-key">т</div>
            <div class="keyboard-key">ь</div>
            <div class="keyboard-key">б</div>
            <div class="keyboard-key">ю</div>
            <div class="keyboard-key">.</div>
        </div>
        <div class="keyboard-row">
            <div class="keyboard-key wide" data-action="backspace">⌫</div>
            <div class="keyboard-key space" data-action="space">Пробел</div>
            <div class="keyboard-key wide" data-action="enter">Ввод</div>
        </div>
    </div>

    <script>
        // Константы игры
        const SCREEN_WIDTH = 1200;
        const SCREEN_HEIGHT = 800;
        const BACKGROUND_COLOR = "#FFF8DC"; // Светло-желтый
        const TEXT_COLOR = "#503232";
        const BUTTON_COLOR = "#FFB6C1";
        const BUTTON_HOVER_COLOR = "#FF69B4";
        const PANEL_COLOR = "#FFFAF0";
        const CATEGORY_COLORS = [
            "#FFB6C1", // Розовый
            "#ADD8E6", // Голубой
            "#90EE90", // Зеленый
            "#FF6347"  // Красный
        ];

        // Шрифты
        const titleFont = "bold 48px Roboto";
        const headerFont = "bold 32px Roboto";
        const normalFont = "24px Roboto";
        const smallFont = "20px Roboto";

        // Глобальные переменные
        let canvas, ctx;
        let game;
        let startBtn, addPlayerBtn, tasksInput, playerInput;
        let showAnswerBtn, acceptBtn, rejectBtn, continueBtn, newGameBtn;
        let activeInputBox = null;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let cursorBlinkState = true;
        let cursorBlinkInterval = null;
        let mouseX = 0, mouseY = 0;

        class Player {
            constructor(name) {
                this.name = name;
                this.score = 0;
                this.color = this.getRandomColor();
                this.avatar = this.generateAvatar();
            }
            
            getRandomColor() {
                const r = Math.floor(50 + Math.random() * 150);
                const g = Math.floor(50 + Math.random() * 150);
                const b = Math.floor(50 + Math.random() * 150);
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            generateAvatar() {
                const canvas = document.createElement("canvas");
                canvas.width = 80;
                canvas.height = 80;
                const ctx = canvas.getContext("2d");
                
                ctx.beginPath();
                ctx.arc(40, 40, 40, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                const initials = this.name.split(" ")
                    .map(n => n[0])
                    .join("")
                    .toUpperCase()
                    .substring(0, 2);
                
                ctx.font = "bold 32px Roboto";
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(initials, 40, 40);
                
                return canvas;
            }
            
            addScore(points) {
                this.score += points;
            }
        }

        class Game {
            constructor() {
                this.players = [];
                this.currentPlayerIdx = 0;
                this.state = "SETUP"; // SETUP, PLAYING, GAME_OVER, INTERMEDIATE_RESULTS
                this.tasksPerCategory = 50;
                this.setupTasks();
                this.selectedCategory = null;
                this.selectedDifficulty = null;
                this.taskWindowOpen = false;
                this.taskResult = null;
                this.tasksCountInput = "50";
                this.showAnswer = false;
                this.roundCounter = 0;
                this.completedTasks = 0;
                this.totalTasks = 0;
                this.tasksRemaining = 0;
                this.taskOffset = [0, 0, 0, 0];
            }
            
            setupTasks() {
                this.categories = ["Логика", "Творчество", "Слова", "Физподготовка"];
                this.tasks = [];
                
                for (let catIdx = 0; catIdx < 4; catIdx++) {
                    const categoryTasks = [];
                    for (let diff = 0; diff < this.tasksPerCategory; diff++) {
                        const task = {
                            description: this.generateTask(catIdx, diff),
                            completed: false,
                            difficulty: diff + 1,
                            answer: this.getAnswer(catIdx, diff)
                        };
                        categoryTasks.push(task);
                    }
                    this.tasks.push(categoryTasks);
                }
                
                this.totalTasks = 4 * this.tasksPerCategory;
                this.tasksRemaining = this.totalTasks;
            }
            
            generateTask(category, difficulty) {
                const diffFactor = difficulty + 1;
                
                if (category === 0) { // Логика
                    const logicTasks = [
                        "Два отца и два сына съели три апельсина. Каждому досталось по апельсину. Как это возможно?",
                        "На столе лежат две монеты, в сумме они дают 3 рубля. Одна из них — не 1 рубль. Какие это монеты?",
                        "Как можно бросить мяч, чтобы он, ударившись о что-либо, вернулся к вам, и при этом мяч не должен ничего задевать, а также к мячу нельзя быть привязанным?",
                        "Представьте, что вы водитель автобуса. Вначале было 10 пассажиров, на первой остановке вышло 5 и вошло 3, на следующей вышло 2 и вошло 8. Сколько лет водителю?",
                        "Один поезд едет из Москвы в Санкт-Петербург, другой — из Санкт-Петербурга в Москву. Оба выехали одновременно, но скорость первого в два раза больше. Какой поезд будет дальше от Москвы в момент встречи?",
                        "У фермера 17 овец. Все, кроме 9, разбежались. Сколько овец осталось у фермера?",
                        "Что можно увидеть с закрытыми глазами?",
                        "Сколько месяцев в году имеют 28 дней?",
                        "Два человека играли в шашки. Каждый сыграл по пять партий и выиграл по пять раз. Как такое возможно?",
                        "Что принадлежит вам, однако другие им пользуются чаще, чем вы?",
                        "Какое слово всегда пишется неправильно?",
                        "Собака была привязана к десятиметровой веревке, а прошла 200 метров. Как?",
                        "Как спрыгнуть с десятиметровой лестницы и не ушибиться?",
                        "Что в огне не горит и в воде не тонет?",
                        "Что нужно делать, когда видишь зелёного человечка?",
                        "Москву раньше называли белокаменной. А какой город называли чёрным?",
                        "В каком процессе вода заменила солнце, через 600 лет песок, а еще через 1100 лет механизм?",
                        "При Петре I на гербе орёл держал карты четырёх морей. Каких?",
                        "Почему в дикой природе белые медведи не едят пингвинов?",
                        "Назовите пять дней, не называя чисел и названий дней",
                        "У тридцати двух воинов один командир. Что это?",
                        "Двенадцать братьев друг за другом бродят, друг друга не обходят. Что это?",
                        "Как правильно говорить: 'не вижу белый желток' или 'не вижу белого желтка'?",
                        "Когда черной кошке лучше всего пробраться в дом?",
                        "Из какой посуды нельзя ничего поесть?",
                        "Маленький, серенький на слона похож. Кто это?",
                        "Какой рукой лучше размешивать чай?",
                        "На какой вопрос нельзя ответить 'да'?",
                        "На какой вопрос нельзя ответить 'нет'?",
                        "Чем оканчиваются день и ночь?",
                        "Что надо сделать, чтобы пять парней остались в одном сапоге?",
                        "В каком месяце болтливая Светочка говорит меньше всего?",
                        "Что становится влажным, пока сохнет?",
                        "Что идет, не двигаясь с места?",
                        "Что можно разбить, даже если его никто не трогает?",
                        "Что имеет много ключей, но не может открыть ни одного замка?",
                        "Что можно поймать, но нельзя бросить?",
                        "Что становится больше, если его перевернуть?",
                        "Что имеет голову и хвост, но нет тела?",
                        "Что можно видеть в закрытой коробке?",
                        "Что летает без крыльев и плачет без глаз?",
                        "Что можно держать в правой руке, но нельзя в левой?",
                        "Что проходит сквозь города и поля, но не двигается?",
                        "Что можно сломать, даже не прикасаясь к нему?",
                        "Что имеет четыре ноги, но не может ходить?",
                        "Что можно слышать, но нельзя увидеть или потрогать?",
                        "Что становится мокрым, пока сохнет?",
                        "Что имеет кольцо, но нет пальца?",
                        "Что можно съесть, но не проглотить?",
                        "Что идет вверх и вниз, но не двигается?",
                        "Что можно открыть, но нельзя закрыть?",
                        "Что имеет руки, но не может хлопать?",
                        "Что становится тяжелее, когда вы берете больше?"
                    ];
                    return logicTasks[difficulty % logicTasks.length];
                }
                else if (category === 1) { // Творчество
                    const creativeTasks = [
                        "Изобразите известную картину так, чтобы другие игроки угадали её название",
                        "Спойте куплет из песни 90-х, заменяя все существительные на названия фруктов",
                        "Расскажите историю, где каждое слово начинается на одну и ту же букву",
                        "Покажите без слов известного исторического персонажа",
                        "Придумайте рекламу для обычного карандаша, как для революционного гаджета",
                        "Изобразите эмоцию, которую назовут другие игроки, используя только мимику",
                        "Расскажите сказку на современный лад (например, 'Колобок' в стиле киберпанк)",
                        "Покажите, как работает ваш воображаемый патентованный бытовой прибор",
                        "Сочините стихотворение из 4 строк о текущем моменте",
                        "Изобразите скульптуру на тему 'Дружба народов'",
                        "Покажите танец робота, который только что узнал о любви",
                        "Придумайте и разыграйте диалог между солнцем и луной",
                        "Изобразите, как животное вашего знака зодиака готовится к собеседованию",
                        "Покажите, как выглядит ваша идеальная суббота в виде пантомимы",
                        "Сочините короткий рассказ, где главный герой - ваша обувь",
                        "Изобразите известную пословицу без слов, чтобы другие угадали",
                        "Придумайте и покажите новый вид спорта для олимпиады 2030 года",
                        "Расскажите анекдот от лица инопланетянина, впервые посетившего Землю",
                        "Изобразите, как выглядел бы ваш ужин в виде современного танца",
                        "Придумайте и покажите рекламу для несуществующей планеты",
                        "Сочините песенку о текущей игре на мотив известной детской песни",
                        "Покажите, как компьютер объясняется в любви принтеру",
                        "Изобразите, как выглядит 'радость' в вашем понимании",
                        "Придумайте и покажите ритуал приветствия для инопланетных гостей",
                        "Расскажите историю в обратном порядке (от конца к началу)",
                        "Покажите, как выглядит 'гнев' в стиле балета",
                        "Придумайте и разыграйте сценку: 'Кот пытается уговорить холодильник дать ему еду'",
                        "Изобразите, как телефон объясняет своему владельцу, что нуждается в зарядке",
                        "Сочините оду предмету, который первым попался вам на глаза",
                        "Покажите танец осенних листьев под воображаемую музыку"
                    ];
                    return creativeTasks[difficulty % creativeTasks.length];
                }
                else if (category === 2) { // Словесные
                    const themes = ["науки", "профессии", "столицы", "реки", "эмоции", "спорт", "транспорт", "искусство"];
                    const letters = "АБВГДЕЖЗИКЛМНОПРСТУФХЦЧШЩЭЮЯ";
                    const letter = letters[Math.floor(Math.random() * letters.length)];
                    const theme = themes[Math.floor(Math.random() * themes.length)];
                    const count = Math.min(5 + Math.floor(difficulty / 2), 15);
                    return `Назовите ${count} ${getWordForm(count, "слово", "слова", "слов")} на букву '${letter}' на тему '${theme}'`;
                }
                else { // Физподготовка
                    const exercises = [
                        `Сделайте ${diffFactor * 2} приседаний`,
                        `Пройдите ${diffFactor} метров на цыпочках`,
                        `Стойте в планке ${diffFactor * 5} секунд`,
                        `Сделайте ${diffFactor * 3} отжиманий от стены`,
                        `Пробегите на месте ${diffFactor * 10} секунд`,
                        `Сделайте ${diffFactor * 2} выпадов на каждую ногу`,
                        `Стойте на одной ноге ${diffFactor * 5} секунд`,
                        `Сделайте ${diffFactor * 4} подъёмов на носки`,
                        `Сделайте ${diffFactor * 3} наклонов вперед`,
                        `Стойте в позе дерева ${diffFactor * 5} секунд`,
                        `Сделайте ${diffFactor * 4} махов ногами`,
                        `Сделайте ${diffFactor * 2} скручиваний на пресс`,
                        `Сделайте ${diffFactor * 4} вращений руками`,
                        `Постойте на цыпочках ${diffFactor * 5} секунд`,
                        `Сделайте растяжку на ${diffFactor * 5} секунд`,
                        `Сделайте ${diffFactor * 2} отжиманий с паузой`,
                        `Пройдите ${diffFactor} метров гусиным шагом`,
                        `Сделайте ${diffFactor * 3} приседаний с прыжком`,
                        `Стойте в позе воина ${diffFactor * 4} секунд`,
                        `Сделайте ${diffFactor * 3} прыжков в длину с места`
                    ];
                    return exercises[difficulty % exercises.length];
                }
            }
            
            getAnswer(category, difficulty) {
                if (category === 0) { // Логика
                    const logicAnswers = [
                        "Это были дед, отец и сын (всего три человека).",
                        "Это монеты 2 рубля и 1 рубль. Одна из них — не 1 рубль, это 2 рубля, а другая — 1 рубль.",
                        "Бросить мяч вверх.",
                        "Столько, сколько вам (вы же водитель).",
                        "В момент встречи они будут на одинаковом расстоянии от Москвы.",
                        "9 овец (разбежались все, кроме 9).",
                        "Сон.",
                        "Все 12 месяцев.",
                        "Они играли не друг с другом.",
                        "Ваше имя.",
                        "Слово 'неправильно'.",
                        "Веревка не была привязана.",
                        "Прыгать с нижней ступени.",
                        "Лед.",
                        "Переходить улицу.",
                        "Чернигов.",
                        "Измерение времени.",
                        "Белое, Каспийское, Азовское, Балтийское.",
                        "Они живут на разных полюсах.",
                        "Позавчера, вчера, сегодня, завтра, послезавтра.",
                        "Зубы и язык.",
                        "Месяцы.",
                        "Желток обычно желтый.",
                        "Когда дверь открыта.",
                        "Из пустой.",
                        "Слоненок.",
                        "Той, в которой ложка.",
                        "Ты спишь?",
                        "Ты жив?",
                        "Мягким знаком.",
                        "Каждому снять по сапогу.",
                        "В феврале.",
                        "Полотенце.",
                        "Часы.",
                        "Обещание.",
                        "Пианино.",
                        "Простуду.",
                        "Число 6.",
                        "Монета.",
                        "Темноту.",
                        "Левый локоть.",
                        "Дорога.",
                        "Обещание.",
                        "Стол.",
                        "Звук.",
                        "Полотенце.",
                        "Телефон.",
                        "Жвачка.",
                        "Лестница.",
                        "Открытие.",
                        "Часы.",
                        "Дыра."
                    ];
                    return logicAnswers[difficulty % logicAnswers.length];
                }
                return "";
            }
            
            startGame() {
                if (this.players.length < 2) return false;
                
                try {
                    const count = parseInt(this.tasksCountInput);
                    if (count < 5 || count > 50) return false;
                    this.tasksPerCategory = count;
                    this.setupTasks();
                    this.state = "PLAYING";
                    this.roundCounter = 0;
                    return true;
                } catch {
                    return false;
                }
            }
            
            addPlayer(name) {
                if (name && this.players.length < 15) {
                    this.players.push(new Player(name));
                    return true;
                }
                return false;
            }
            
            nextPlayer() {
                this.currentPlayerIdx = (this.currentPlayerIdx + 1) % this.players.length;
                
                if (this.currentPlayerIdx === 0) {
                    this.roundCounter++;
                    
                    if (this.tasksRemaining < this.players.length) {
                        this.state = "GAME_OVER";
                    } else {
                        this.state = "INTERMEDIATE_RESULTS";
                    }
                }
            }
            
            selectTask(category, difficulty) {
                if (!this.taskWindowOpen && category >= 0 && category < 4 && 
                    difficulty >= 0 && difficulty < this.tasksPerCategory) {
                    
                    const task = this.tasks[category][difficulty];
                    if (!task.completed) {
                        this.selectedCategory = category;
                        this.selectedDifficulty = difficulty;
                        this.taskWindowOpen = true;
                        this.showAnswer = false;
                        return true;
                    }
                }
                return false;
            }
            
            completeTask(success) {
                if (this.selectedCategory !== null && this.selectedDifficulty !== null) {
                    const task = this.tasks[this.selectedCategory][this.selectedDifficulty];
                    if (!task.completed) {
                        task.completed = true;
                        this.completedTasks++;
                        this.tasksRemaining--;
                        
                        if (success) {
                            const points = task.difficulty;
                            this.players[this.currentPlayerIdx].addScore(points);
                        }
                        
                        this.taskWindowOpen = false;
                        this.nextPlayer();
                        return true;
                    }
                }
                return false;
            }
        }

        // Вспомогательная функция для склонения слов
        function getWordForm(number, form1, form2, form5) {
            number = Math.abs(number) % 100;
            const remainder = number % 10;
            
            if (number > 10 && number < 20) return form5;
            if (remainder > 1 && remainder < 5) return form2;
            if (remainder === 1) return form1;
            return form5;
        }

        class Button {
            constructor(x, y, width, height, text, color = BUTTON_COLOR, hoverColor = BUTTON_HOVER_COLOR) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.text = text;
                this.color = color;
                this.hoverColor = hoverColor;
                this.isHovered = false;
            }
            
            draw(ctx) {
                ctx.fillStyle = this.isHovered ? this.hoverColor : this.color;
                this.drawRoundedRect(ctx, this.x, this.y, this.width, this.height, 10);
                ctx.strokeStyle = TEXT_COLOR;
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fill();
                
                ctx.fillStyle = "white";
                ctx.font = normalFont;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(this.text, this.x + this.width / 2, this.y + this.height / 2);
            }
            
            drawRoundedRect(ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                ctx.lineTo(x + radius, y + height);
                ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.closePath();
            }
            
            checkHover(mouseX, mouseY) {
                this.isHovered = (
                    mouseX >= this.x && 
                    mouseX <= this.x + this.width && 
                    mouseY >= this.y && 
                    mouseY <= this.y + this.height
                );
                return this.isHovered;
            }
            
            isClicked(mouseX, mouseY) {
                return this.checkHover(mouseX, mouseY);
            }
        }

        class InputBox {
            constructor(x, y, width, height, text = "") {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.text = text;
                this.active = false;
                this.cursorVisible = true;
            }
            
            isPointInside(x, y) {
                return x >= this.x && x <= this.x + this.width && 
                       y >= this.y && y <= this.y + this.height;
            }
            
            activate() {
                this.active = true;
                this.cursorVisible = true;
                if (isMobile) {
                    document.getElementById('mobileKeyboard').style.display = 'flex';
                }
            }
            
            deactivate() {
                this.active = false;
                this.cursorVisible = false;
                if (isMobile) {
                    // Не скрываем клавиатуру сразу, чтобы пользователь мог продолжать ввод
                }
            }
            
            draw(ctx) {
                ctx.fillStyle = "white";
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                ctx.strokeStyle = this.active ? "#64A0D2" : "#C8C8C8";
                ctx.lineWidth = 2;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
                
                ctx.fillStyle = "black";
                ctx.font = normalFont;
                ctx.textAlign = "left";
                ctx.textBaseline = "top";
                ctx.fillText(this.text, this.x + 5, this.y + 5);
                
                if (this.active && this.cursorVisible) {
                    const textWidth = ctx.measureText(this.text).width;
                    ctx.beginPath();
                    ctx.moveTo(this.x + textWidth + 8, this.y + 5);
                    ctx.lineTo(this.x + textWidth + 8, this.y + this.height - 5);
                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }

        // Функции отрисовки экранов
        function drawSetupScreen() {
            // Очистка экрана
            ctx.fillStyle = BACKGROUND_COLOR;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Заголовок
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = titleFont;
            ctx.textAlign = "center";
            ctx.fillText("Подарочек - Игра", SCREEN_WIDTH / 2, 100);
            
            // Панель настроек
            ctx.fillStyle = PANEL_COLOR;
            ctx.fillRect(SCREEN_WIDTH / 2 - 300, 150, 600, 500);
            ctx.strokeStyle = TEXT_COLOR;
            ctx.lineWidth = 3;
            ctx.strokeRect(SCREEN_WIDTH / 2 - 300, 150, 600, 500);
            
            // Подзаголовок
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = headerFont;
            ctx.fillText("Настройки игры", SCREEN_WIDTH / 2, 200);
            
            // Надписи
            ctx.font = normalFont;
            ctx.textAlign = "right";
            ctx.fillText("Количество заданий на категорию:", 550, 270);
            ctx.fillText("Добавить игрока:", 550, 340);
            
            // Поле ввода количества заданий
            tasksInput.draw(ctx);
            
            // Поле ввода игрока
            playerInput.draw(ctx);
            
            // Кнопка добавления игрока
            addPlayerBtn.draw(ctx);
            
            // Список игроков
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = headerFont;
            ctx.textAlign = "center";
            ctx.fillText("Игроки (" + game.players.length + ")", SCREEN_WIDTH / 2, 420);
            
            ctx.font = normalFont;
            ctx.textAlign = "left";
            for (let i = 0; i < game.players.length; i++) {
                ctx.fillText(`${i+1}. ${game.players[i].name}`, SCREEN_WIDTH / 2 - 280, 460 + i * 40);
            }
            
            // Кнопка старта
            if (game.players.length >= 2) {
                startBtn.draw(ctx);
            } else {
                ctx.fillStyle = "#CCCCCC";
                ctx.fillRect(startBtn.x, startBtn.y, startBtn.width, startBtn.height);
                ctx.fillStyle = TEXT_COLOR;
                ctx.textAlign = "center";
                ctx.fillText("Нужно минимум 2 игрока", startBtn.x + startBtn.width / 2, startBtn.y + startBtn.height / 2);
            }
        }
        
        function drawPlayingScreen() {
            // Очистка экрана
            ctx.fillStyle = BACKGROUND_COLOR;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Заголовок
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = titleFont;
            ctx.textAlign = "center";
            ctx.fillText("Игровое поле", SCREEN_WIDTH / 2, 80);
            
            // Информация о текущем игроке
            const currentPlayer = game.players[game.currentPlayerIdx];
            ctx.font = headerFont;
            ctx.fillText(`Сейчас ходит: ${currentPlayer.name}`, SCREEN_WIDTH / 2, 130);
            ctx.fillText(`Счет: ${currentPlayer.score}`, SCREEN_WIDTH / 2, 170);
            
            // Отрисовка игрового поля (категории)
            const cellWidth = 280;
            const cellHeight = 120;
            const startX = (SCREEN_WIDTH - cellWidth * 4) / 2;
            const startY = 220;
            
            for (let i = 0; i < 4; i++) {
                ctx.fillStyle = CATEGORY_COLORS[i];
                ctx.fillRect(startX + i * cellWidth, startY, cellWidth, cellHeight);
                ctx.strokeStyle = TEXT_COLOR;
                ctx.lineWidth = 2;
                ctx.strokeRect(startX + i * cellWidth, startY, cellWidth, cellHeight);
                
                // Название категории
                ctx.fillStyle = "white";
                ctx.font = headerFont;
                ctx.textAlign = "center";
                ctx.fillText(game.categories[i], startX + i * cellWidth + cellWidth / 2, startY + 40);
                
                // Задания в категории
                ctx.font = normalFont;
                const visibleTasks = Math.min(5, game.tasksPerCategory - game.taskOffset[i]);
                for (let j = 0; j < visibleTasks; j++) {
                    const task = game.tasks[i][game.taskOffset[i] + j];
                    const taskY = startY + cellHeight + 10 + j * 40;
                    
                    if (task.completed) {
                        ctx.fillStyle = "#CCCCCC";
                    } else {
                        ctx.fillStyle = TEXT_COLOR;
                    }
                    
                    ctx.fillText(`${task.difficulty} баллов`, startX + i * cellWidth + cellWidth / 2, taskY);
                }
            }
            
            // Кнопки прокрутки
            for (let i = 0; i < 4; i++) {
                if (game.taskOffset[i] > 0) {
                    ctx.fillStyle = "#64A0D2";
                    ctx.beginPath();
                    ctx.moveTo(startX + i * cellWidth + cellWidth / 2 - 10, startY + cellHeight + 5);
                    ctx.lineTo(startX + i * cellWidth + cellWidth / 2 + 10, startY + cellHeight + 5);
                    ctx.lineTo(startX + i * cellWidth + cellWidth / 2, startY + cellHeight - 10);
                    ctx.fill();
                }
                
                if (game.taskOffset[i] < game.tasksPerCategory - 5) {
                    ctx.fillStyle = "#64A0D2";
                    ctx.beginPath();
                    ctx.moveTo(startX + i * cellWidth + cellWidth / 2 - 10, startY + cellHeight + 5 + 40 * 5);
                    ctx.lineTo(startX + i * cellWidth + cellWidth / 2 + 10, startY + cellHeight + 5 + 40 * 5);
                    ctx.lineTo(startX + i * cellWidth + cellWidth / 2, startY + cellHeight + 20 + 40 * 5);
                    ctx.fill();
                }
            }
        }
        
        function drawTaskWindow() {
            // Полупрозрачный фон
            ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Окно задания
            ctx.fillStyle = PANEL_COLOR;
            ctx.fillRect(100, 100, SCREEN_WIDTH - 200, SCREEN_HEIGHT - 200);
            ctx.strokeStyle = TEXT_COLOR;
            ctx.lineWidth = 3;
            ctx.strokeRect(100, 100, SCREEN_WIDTH - 200, SCREEN_HEIGHT - 200);
            
            // Заголовок
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = headerFont;
            ctx.textAlign = "center";
            ctx.fillText("Задание", SCREEN_WIDTH / 2, 150);
            
            // Категория и сложность
            const task = game.tasks[game.selectedCategory][game.selectedDifficulty];
            ctx.font = normalFont;
            ctx.fillText(`Категория: ${game.categories[game.selectedCategory]}`, SCREEN_WIDTH / 2, 200);
            ctx.fillText(`Сложность: ${task.difficulty} баллов`, SCREEN_WIDTH / 2, 240);
            
            // Описание задания
            ctx.textAlign = "left";
            const lines = wrapText(ctx, task.description, 200, 280, SCREEN_WIDTH - 400, normalFont);
            
            // Ответ (если показан)
            if (game.showAnswer) {
                ctx.font = headerFont;
                ctx.textAlign = "center";
                ctx.fillText("Ответ:", SCREEN_WIDTH / 2, 350);
                
                ctx.font = normalFont;
                ctx.textAlign = "left";
                wrapText(ctx, task.answer, 200, 400, SCREEN_WIDTH - 400, normalFont);
            }
            
            // Кнопки
            if (!game.showAnswer) {
                showAnswerBtn.x = SCREEN_WIDTH / 2 - 100;
                showAnswerBtn.y = SCREEN_HEIGHT - 250;
                showAnswerBtn.draw(ctx);
            } else {
                acceptBtn.x = SCREEN_WIDTH / 2 - 200;
                acceptBtn.y = SCREEN_HEIGHT - 250;
                acceptBtn.draw(ctx);
                
                rejectBtn.x = SCREEN_WIDTH / 2 + 20;
                rejectBtn.y = SCREEN_HEIGHT - 250;
                rejectBtn.draw(ctx);
            }
        }
        
        function drawIntermediateResults() {
            // Очистка экрана
            ctx.fillStyle = BACKGROUND_COLOR;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Заголовок
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = titleFont;
            ctx.textAlign = "center";
            ctx.fillText("Промежуточные результаты", SCREEN_WIDTH / 2, 100);
            ctx.font = headerFont;
            ctx.fillText(`Раунд ${game.roundCounter} завершен!`, SCREEN_WIDTH / 2, 150);
            
            // Список игроков
            const sortedPlayers = [...game.players].sort((a, b) => b.score - a.score);
            const startY = 200;
            
            for (let i = 0; i < sortedPlayers.length; i++) {
                const player = sortedPlayers[i];
                const y = startY + i * 100;
                
                // Аватар
                ctx.drawImage(player.avatar, 200, y - 40);
                
                // Информация
                ctx.fillStyle = TEXT_COLOR;
                ctx.font = headerFont;
                ctx.textAlign = "left";
                ctx.fillText(`${i+1}. ${player.name}`, 300, y);
                ctx.fillText(`Счет: ${player.score}`, 300, y + 40);
                
                // Прогресс
                ctx.fillStyle = "#DDDDDD";
                ctx.fillRect(500, y + 40, 400, 20);
                ctx.fillStyle = player.color;
                ctx.fillRect(500, y + 40, 400 * (player.score / 100), 20);
            }
            
            // Кнопка продолжения
            continueBtn.x = SCREEN_WIDTH / 2 - 100;
            continueBtn.y = SCREEN_HEIGHT - 150;
            continueBtn.draw(ctx);
        }
        
        function drawGameOverScreen() {
            // Очистка экрана
            ctx.fillStyle = BACKGROUND_COLOR;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Заголовок
            ctx.fillStyle = TEXT_COLOR;
            ctx.font = titleFont;
            ctx.textAlign = "center";
            ctx.fillText("Игра завершена!", SCREEN_WIDTH / 2, 100);
            
            // Победитель
            const winner = game.players.reduce((prev, current) => 
                (prev.score > current.score) ? prev : current
            );
            
            ctx.font = headerFont;
            ctx.fillText(`Победитель: ${winner.name} с ${winner.score} очками!`, SCREEN_WIDTH / 2, 180);
            
            // Статистика
            ctx.font = normalFont;
            ctx.fillText(`Всего выполнено заданий: ${game.completedTasks} из ${game.totalTasks}`, SCREEN_WIDTH / 2, 250);
            
            // Кнопка новой игры
            newGameBtn.x = SCREEN_WIDTH / 2 - 100;
            newGameBtn.y = SCREEN_HEIGHT - 200;
            newGameBtn.draw(ctx);
        }
        
        function wrapText(ctx, text, x, y, maxWidth, font) {
            const words = text.split(' ');
            let line = '';
            let lines = [];
            
            ctx.font = font;
            
            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                
                if (testWidth > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);
            
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, y + (i * 30));
            }
            
            return lines;
        }

        // Инициализация игры
        function init() {
            canvas = document.getElementById("gameCanvas");
            ctx = canvas.getContext("2d");
            
            game = new Game();
            
            // Создание элементов UI с правильными позициями
            startBtn = new Button(SCREEN_WIDTH / 2 - 100, 600, 200, 60, "Начать игру");
            addPlayerBtn = new Button(SCREEN_WIDTH / 2 - 100, 380, 200, 60, "Добавить игрока");
            tasksInput = new InputBox(650, 250, 200, 40, "50");
            playerInput = new InputBox(650, 320, 200, 40);
            
            // Кнопки для окна задания
            showAnswerBtn = new Button(0, 0, 180, 50, "Показать ответ");
            acceptBtn = new Button(0, 0, 180, 50, "Принять", "#90EE90");
            rejectBtn = new Button(0, 0, 180, 50, "Отклонить", "#FF6347");
            
            // Кнопки для других экранов
            continueBtn = new Button(0, 0, 200, 60, "Продолжить игру");
            newGameBtn = new Button(0, 0, 200, 60, "Новая игра");
            
            // Инициализация мобильной клавиатуры
            if (isMobile) {
                const keyboard = document.getElementById('mobileKeyboard');
                const keys = keyboard.querySelectorAll('.keyboard-key');
                const textControls = keyboard.querySelectorAll('.text-control-btn');
                
                // Обработка обычных клавиш
                keys.forEach(key => {
                    key.addEventListener('click', function() {
                        if (!activeInputBox) return;
                        
                        const action = this.getAttribute('data-action');
                        if (action === 'backspace') {
                            activeInputBox.text = activeInputBox.text.slice(0, -1);
                        } else if (action === 'space') {
                            activeInputBox.text += ' ';
                        } else if (action === 'enter') {
                            // Обработка Enter
                            if (activeInputBox === playerInput) {
                                if (game.addPlayer(playerInput.text)) {
                                    playerInput.text = "";
                                }
                            }
                        } else {
                            activeInputBox.text += this.textContent;
                        }
                    });
                });
                
                // Обработка кнопок управления текстом
                textControls.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        if (action === 'selectAll' && activeInputBox) {
                            // Запоминаем текст для возможной вставки
                            navigator.clipboard.writeText(activeInputBox.text);
                        } else if (action === 'clear' && activeInputBox) {
                            activeInputBox.text = "";
                        } else if (action === 'closeKeyboard') {
                            keyboard.style.display = 'none';
                            if (activeInputBox) {
                                activeInputBox.active = false;
                                activeInputBox.cursorVisible = false;
                            }
                        }
                    });
                });
            }
            
            // Обработчики событий
            canvas.addEventListener('click', handleClick);
            canvas.addEventListener('mousemove', handleMouseMove);
            
            // Запуск анимации мигания курсора
            cursorBlinkInterval = setInterval(() => {
                cursorBlinkState = !cursorBlinkState;
                if (activeInputBox) {
                    activeInputBox.cursorVisible = cursorBlinkState;
                }
            }, 500);
            
            // Скрываем загрузчик
            document.getElementById('loader').style.display = 'none';
            
            // Запуск игрового цикла
            requestAnimationFrame(gameLoop);
        }
        
        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Обновляем позицию мыши
            mouseX = x;
            mouseY = y;
            
            // Проверяем, где был клик
            if (game.state === "SETUP") {
                // Проверка полей ввода
                if (tasksInput.isPointInside(x, y)) {
                    if (activeInputBox) activeInputBox.deactivate();
                    tasksInput.activate();
                    activeInputBox = tasksInput;
                } else if (playerInput.isPointInside(x, y)) {
                    if (activeInputBox) activeInputBox.deactivate();
                    playerInput.activate();
                    activeInputBox = playerInput;
                } else {
                    if (activeInputBox) activeInputBox.deactivate();
                    activeInputBox = null;
                }
                
                // Кнопка добавления игрока
                if (addPlayerBtn.isClicked(x, y)) {
                    if (game.addPlayer(playerInput.text)) {
                        playerInput.text = "";
                    }
                }
                
                // Кнопка начала игры
                if (startBtn.isClicked(x, y)) {
                    game.tasksCountInput = tasksInput.text;
                    game.startGame();
                }
            }
            else if (game.state === "PLAYING" && !game.taskWindowOpen) {
                // Обработка выбора задания
                const cellWidth = 280;
                const cellHeight = 120;
                const startX = (SCREEN_WIDTH - cellWidth * 4) / 2;
                const startY = 220;
                
                for (let i = 0; i < 4; i++) {
                    // Проверка категорий
                    if (x > startX + i * cellWidth && x < startX + (i + 1) * cellWidth && 
                        y > startY && y < startY + cellHeight) {
                        // Прокрутка заданий
                        if (y > startY + cellHeight && y < startY + cellHeight + 20) {
                            if (game.taskOffset[i] > 0) {
                                game.taskOffset[i]--;
                            }
                        } else if (y > startY + cellHeight + 20 + 40 * 5 && y < startY + cellHeight + 40 + 40 * 5) {
                            if (game.taskOffset[i] < game.tasksPerCategory - 5) {
                                game.taskOffset[i]++;
                            }
                        } else {
                            // Выбор задания
                            for (let j = 0; j < 5; j++) {
                                if (y > startY + cellHeight + 10 + j * 40 && 
                                    y < startY + cellHeight + 10 + (j + 1) * 40) {
                                    const taskIdx = game.taskOffset[i] + j;
                                    game.selectTask(i, taskIdx);
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            else if (game.state === "PLAYING" && game.taskWindowOpen) {
                // Кнопки в окне задания
                if (showAnswerBtn.isClicked(x, y)) {
                    game.showAnswer = true;
                } else if (acceptBtn.isClicked(x, y)) {
                    game.completeTask(true);
                } else if (rejectBtn.isClicked(x, y)) {
                    game.completeTask(false);
                }
            }
            else if (game.state === "INTERMEDIATE_RESULTS") {
                if (continueBtn.isClicked(x, y)) {
                    game.state = "PLAYING";
                }
            }
            else if (game.state === "GAME_OVER") {
                if (newGameBtn.isClicked(x, y)) {
                    game = new Game();
                }
            }
        }
        
        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            
            // Обновление состояния кнопок
            if (game.state === "SETUP") {
                addPlayerBtn.checkHover(mouseX, mouseY);
                if (game.players.length >= 2) {
                    startBtn.checkHover(mouseX, mouseY);
                }
            }
            else if (game.state === "PLAYING" && game.taskWindowOpen) {
                if (!game.showAnswer) {
                    showAnswerBtn.checkHover(mouseX, mouseY);
                } else {
                    acceptBtn.checkHover(mouseX, mouseY);
                    rejectBtn.checkHover(mouseX, mouseY);
                }
            }
            else if (game.state === "INTERMEDIATE_RESULTS") {
                continueBtn.checkHover(mouseX, mouseY);
            }
            else if (game.state === "GAME_OVER") {
                newGameBtn.checkHover(mouseX, mouseY);
            }
        }
        
        function gameLoop() {
            // Отрисовка в зависимости от состояния игры
            switch (game.state) {
                case "SETUP":
                    drawSetupScreen();
                    break;
                case "PLAYING":
                    if (game.taskWindowOpen) {
                        drawTaskWindow();
                    } else {
                        drawPlayingScreen();
                    }
                    break;
                case "INTERMEDIATE_RESULTS":
                    drawIntermediateResults();
                    break;
                case "GAME_OVER":
                    drawGameOverScreen();
                    break;
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Запуск игры после загрузки страницы
        window.addEventListener('load', init);
    </script>
</body>
</html>
